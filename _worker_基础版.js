import{connect as C}from"cloudflare:sockets";function x(e){if("string"!=typeof e)throw new TypeError("sha224Encrypt: input must be a string");let t=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298];function r(e,t){return e>>>t|e<<32-t}let a=(new TextEncoder).encode(e),n=8*a.length,s=a.length+9+63>>6<<6,o=new Uint8Array(s);o.set(a),o[a.length]=128,new DataView(o.buffer).setUint32(o.length-4,n,!1);let i=new Uint32Array(64),l=[3238371032,914150663,812702999,4144912697,4290775857,1750603025,1694076839,3204075428].slice();for(let e=0;e<o.length;e+=64){let a=new DataView(o.buffer,e,64);for(let e=0;e<16;e++)i[e]=a.getUint32(4*e);for(let e=16;e<64;e++){let t=r(i[e-15],7)^r(i[e-15],18)^i[e-15]>>>3,a=r(i[e-2],17)^r(i[e-2],19)^i[e-2]>>>10;i[e]=i[e-16]+t+i[e-7]+a>>>0}let[n,s,c,u,d,w,p,h]=l;for(let e=0;e<64;e++){let a=h+(r(d,6)^r(d,11)^r(d,25))+(d&w^~d&p)+t[e]+i[e]>>>0,o=(r(n,2)^r(n,13)^r(n,22))+(n&s^n&c^s&c)>>>0;[h,p,w,d,u,c,s,n]=[p,w,d,u+a>>>0,c,s,n,a+o>>>0]}l[0]=l[0]+n>>>0,l[1]=l[1]+s>>>0,l[2]=l[2]+c>>>0,l[3]=l[3]+u>>>0,l[4]=l[4]+d>>>0,l[5]=l[5]+w>>>0,l[6]=l[6]+p>>>0,l[7]=l[7]+h>>>0}return l.slice(0,7).map(e=>e.toString(16).padStart(8,"0")).join("")}function W(e){let t,r,a=e=>(e=+e)>=1&&e<=65535?e:443,n=443;if("["===e[0]){if(-1===(r=e.indexOf("]")))return{hostname:null,port:null};t=e.slice(0,r+1),":"===e[r+1]&&(n=a(e.slice(r+2)))}else-1!==(r=e.lastIndexOf(":"))&&e.indexOf(":")===r?(t=e.slice(0,r),n=a(e.slice(r+1))):t=e;return{hostname:t,port:n}}var j="",E=`${["2001","67c","2960","6464"].join(":")}::`,$="a1234567",L=x($),I={hostname:null,port:null},P=["https://www.bilibili.com","https://www.nicovideo.jp","https://tv.naver.com","https://www.hotstar.com","https://www.netflix.com","https://www.dailymotion.com","https://www.youtube.com","https://www.hulu.com","https://fmovies.llc","https://hdtodayz.to","https://radar.cloudflare.com"],X={async fetch(e,t,r){try{E=t.NAT64_IPV6PREFIX||E;let r=t.LANDING_ADDRESS||j,a=t.PASS_CODE||$;a!==$&&(L=x(a));let n=new URL(e.url).pathname,s=e.headers.get("Upgrade");if(s&&"websocket"===s){n.includes("/pyip=")&&(r=n.split("/pyip=")[1]);let t=W(r);return I={hostname:t?.hostname,port:t?.port},await O(e)}if("/"===n){let e=P[Math.floor(Math.random()*P.length)];return new Response("",{status:301,headers:{Location:e}})}return new Response("404 Not Found!",{status:404,headers:{"Content-Type":"text/plain; charset=utf-8"}})}catch(e){return new Response(e.toString())}}};async function O(e){let t=new WebSocketPair,[r,a]=Object.values(t);a.accept();let n="",s="",o=(e,t)=>{},i=e.headers.get("sec-websocket-protocol")||"",l=F(a,i,o),c={value:null,writer:null};return l.pipeTo(new WritableStream({async write(e,t){if(c.writer)return void await c.writer.write(e);if(c.value)return c.writer=c.value.writable.getWriter(),void await c.writer.write(e);let r=await V(e,L);r&&!r.hasError&&(n=r?.addressRemote,s=`${r?.portRemote}--${Math.random()} tcp`,H(c,n,r?.portRemote,r?.rawClientData,a,o))},close(){},abort(e){JSON.stringify(e)}})).catch(e=>{}),new Response(null,{status:101,webSocket:r})}async function V(e,t){if(e.byteLength<56)return{hasError:!0,message:"invalid data"};if(13!==new Uint8Array(e.slice(56,57))[0]||10!==new Uint8Array(e.slice(57,58))[0])return{hasError:!0,message:"invalid header format (missing CR LF)"};if((new TextDecoder).decode(e.slice(0,56))!==t)return{hasError:!0,message:"invalid password"};let r=e.slice(58);if(r.byteLength<6)return{hasError:!0,message:"invalid SOCKS5 request data"};let a=new DataView(r);if(1!==a.getUint8(0))return{hasError:!0,message:"unsupported command, only TCP (CONNECT) is allowed"};let n=a.getUint8(1),s=0,o=2,i="";switch(n){case 1:s=4,i=new Uint8Array(r.slice(o,o+s)).join(".");break;case 3:s=new Uint8Array(r.slice(o,o+1))[0],o+=1,i=(new TextDecoder).decode(r.slice(o,o+s));break;case 4:s=16;let e=new DataView(r.slice(o,o+s)),t=[];for(let r=0;r<8;r++)t.push(e.getUint16(2*r).toString(16));i=t.join(":");break;default:return{hasError:!0,message:`invalid addressType is ${n}`}}if(!i)return{hasError:!0,message:`address is empty, addressType is ${n}`};let l=o+s,c=r.slice(l,l+2);return{hasError:!1,addressRemote:i,portRemote:new DataView(c).getUint16(0),rawClientData:r.slice(l+4)}}async function H(e,t,r,a,n,s){async function o(t,r){let n=C({hostname:t,port:r});e.value=n,s(`connected to ${t}:${r}`);let o=n.writable.getWriter();return await o.write(a),o.releaseLock(),n}T(await o(t,r),n,async function(){let{address:e,port:a}=await B(t,r),i=await o(e,a);i.closed.catch(e=>{}).finally(()=>S(ws)),T(i,n,null,s)},s)}async function B(e,t,r=I){return r?.hostname?{address:r.hostname,port:r.port||t}:{address:await _(e)||e,port:t}}async function _(e,t=E){if("string"!=typeof e||!e.trim())return"";try{let r=await fetch(`https://1.1.1.1/dns-query?name=${e}&type=A`,{headers:{Accept:"application/dns-json"}});if(!r.ok)return"";let a=(await r.json()).Answer?.find(e=>1===e.type)?.data;if(!a)return"";let n=a.split(".");if(4!==n.length)return"";let s=n.map(e=>{let t=Number(e);return!Number.isInteger(t)||t<0||t>255?null:t.toString(16).padStart(2,"0")});return s.includes(null)?"":`[${t}${s[0]}${s[1]}:${s[2]}${s[3]}]`}catch{return""}}function F(e,t,r){let a=!1;return new ReadableStream({start(n){e.addEventListener("message",e=>{a||n.enqueue(e.data)}),e.addEventListener("close",()=>{a||n.close(),S(e)}),e.addEventListener("error",e=>{r("WebSocket error"),n.error(e)});let{earlyData:s,error:o}=M(t);o?n.error(o):s&&n.enqueue(s)},cancel(t){a||(a=!0,r(`ReadableStream canceled: ${t}`),S(e))}})}async function T(e,t,r,a){let n=!1;await e.readable.pipeTo(new WritableStream({start(){},async write(e,r){n=!0,t.readyState!==WebSocket.OPEN&&r.error("webSocket connection is not open"),t.send(e)},close(){a(`remoteSocket.readable is closed, hasIncomingData: ${n}`)},abort(e){}})).catch(e=>{S(t)}),!1===n&&r&&(a("retry"),r())}function M(e){if(!e)return{earlyData:null,error:null};try{let t=e.replace(/-/g,"+").replace(/_/g,"/"),r=atob(t),a=r.length,n=new Uint8Array(a);for(let e=0;e<a;e++)n[e]=r.charCodeAt(e);return{earlyData:n.buffer,error:null}}catch(e){return{earlyData:null,error:e}}}function S(e,t=1e3,r="Normal Closure"){try{(e.readyState===WebSocket.OPEN||e.readyState===WebSocket.CONNECTING)&&e.close(t,r)}catch{}}export{X as default};