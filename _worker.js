import{connect as te}from"cloudflare:sockets";function O(e){if("string"!=typeof e)throw new TypeError("sha224Encrypt: input must be a string");let t=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298];function n(e,t){return e>>>t|e<<32-t}let r=(new TextEncoder).encode(e),a=8*r.length,i=r.length+9+63>>6<<6,o=new Uint8Array(i);o.set(r),o[r.length]=128,new DataView(o.buffer).setUint32(o.length-4,a,!1);let s=new Uint32Array(64),c=[3238371032,914150663,812702999,4144912697,4290775857,1750603025,1694076839,3204075428].slice();for(let e=0;e<o.length;e+=64){let r=new DataView(o.buffer,e,64);for(let e=0;e<16;e++)s[e]=r.getUint32(4*e);for(let e=16;e<64;e++){let t=n(s[e-15],7)^n(s[e-15],18)^s[e-15]>>>3,r=n(s[e-2],17)^n(s[e-2],19)^s[e-2]>>>10;s[e]=s[e-16]+t+s[e-7]+r>>>0}let[a,i,l,I,u,g,d,C]=c;for(let e=0;e<64;e++){let r=C+(n(u,6)^n(u,11)^n(u,25))+(u&g^~u&d)+t[e]+s[e]>>>0,o=(n(a,2)^n(a,13)^n(a,22))+(a&i^a&l^i&l)>>>0;[C,d,g,u,I,l,i,a]=[d,g,u,I+r>>>0,l,i,a,r+o>>>0]}c[0]=c[0]+a>>>0,c[1]=c[1]+i>>>0,c[2]=c[2]+l>>>0,c[3]=c[3]+I>>>0,c[4]=c[4]+u>>>0,c[5]=c[5]+g>>>0,c[6]=c[6]+d>>>0,c[7]=c[7]+C>>>0}return c.slice(0,7).map(e=>e.toString(16).padStart(8,"0")).join("")}function ee(e,t){let n=[];for(let r=0;r<e.length;r+=t)n.push(e.slice(r,r+t));return n}function G(e,t,n,r=500,a=300){if(!Array.isArray(e))return{hasError:!0,message:"输入数据不是有效的数组"};let i=ee(e,t>0&&t<=r?t:a),o=i.length;return n>o||n<1?{hasError:!0,message:"数据为空，或者没有该页数，数据过少远达不到这个页码！"}:{chunkedIPs:i[n-1],totalPage:o}}function L(e){let t,n,r=e=>(e=+e)>=1&&e<=65535?e:443,a=443;if("["===e[0]){if(-1===(n=e.indexOf("]")))return{hostname:null,port:null};t=e.slice(0,n+1),":"===e[n+1]&&(a=r(e.slice(n+2)))}else-1!==(n=e.lastIndexOf(":"))&&e.indexOf(":")===n?(t=e.slice(0,n),a=r(e.slice(n+1))):t=e;return{hostname:t,port:a}}async function V(e,t,n,r,a="main"){let i=`https://api.github.com/repos/${t}/${n}/contents/${r}?ref=${a}`;try{let t=await fetch(i,{headers:{Authorization:`token ${e}`,Accept:"application/vnd.github.v3.raw","User-Agent":"Mozilla/5.0"}});if(!t.ok)return o();let n=t.headers.get("Content-Type")||"application/octet-stream";return{body:await t.arrayBuffer(),contentType:n}}catch{return o()}function o(){return{body:new ArrayBuffer(0),contentType:"text/plain; charset=utf-8"}}}async function J(e){try{let t=await fetch(e);if(t.ok)return await t.text()}catch{}return""}function P(e){let t=(new TextEncoder).encode(e),n=Array.from(t,e=>String.fromCharCode(e)).join("");return btoa(n)}function m(e){let t=atob(e),n=new Uint8Array([...t].map(e=>e.charCodeAt(0)));return(new TextDecoder).decode(n)}function B(e,t){let n=!!t.endsWith(m("d29ya2Vycy5kZXY")),r={"#password#":e,"#address#":"www.visa.com.sg","#port#":n?8080:443,"#host#":t},a=new RegExp(Object.keys(r).concat("#onTls#").join("|"),"g"),i=m("dHJvamFuOi8vI3Bhc3N3b3JkI0AjYWRkcmVzcyM6I3BvcnQjP3NlY3VyaXR5PSNvblRscyMmdHlwZT13cyZob3N0PSNob3N0IyZwYXRoPSUyRiMjYWRkcmVzcyM").replace(a,e=>"#onTls#"===e?n?"none":m("dGxzJnNuaT0jaG9zdCMmZnA9Y2hyb21lJmFsbG93SW5zZWN1cmU9MQ").replace("#host#",t):r[e]),o=new RegExp(Object.keys(r).join("|"),"g"),s=m("LSB0eXBlOiB0cm9qYW4NCiAgbmFtZTogI2FkZHJlc3MjDQogIHNlcnZlcjogI2FkZHJlc3MjDQogIHBvcnQ6ICNwb3J0Iw0KICBwYXNzd29yZDogI3Bhc3N3b3JkIw0KICBuZXR3b3JrOiB3cw0KICB1ZHA6IGZhbHNlDQogIHNuaTogI2hvc3QjDQogIGNsaWVudC1maW5nZXJwcmludDogY2hyb21lDQogIHNraXAtY2VydC12ZXJpZnk6IHRydWUNCiAgd3Mtb3B0czoNCiAgICBwYXRoOiAvDQogICAgaGVhZGVyczoNCiAgICAgIEhvc3Q6ICNob3N0Iw").replace(o,e=>r[e]),c=m("ew0KICAib3V0Ym91bmRzIjogWw0KICAgIHsNCiAgICAgICJuZXR3b3JrIjogInRjcCIsDQogICAgICAicGFzc3dvcmQiOiAiI3Bhc3N3b3JkIyIsDQogICAgICAic2VydmVyIjogIiNhZGRyZXNzIyIsDQogICAgICAic2VydmVyX3BvcnQiOiAjcG9ydCMsDQogICAgICAidGFnIjogIiNhZGRyZXNzIzojcG9ydCMiLA0KICAgICAgInRscyI6IHsNCiAgICAgICAgImVuYWJsZWQiOiAjb25UbHMjLA0KICAgICAgICAiaW5zZWN1cmUiOiB0cnVlLA0KICAgICAgICAic2VydmVyX25hbWUiOiAiI2hvc3QjIiwNCiAgICAgICAgInV0bHMiOiB7DQogICAgICAgICAgImVuYWJsZWQiOiB0cnVlLA0KICAgICAgICAgICJmaW5nZXJwcmludCI6ICJjaHJvbWUiDQogICAgICAgIH0NCiAgICAgIH0sDQogICAgICAidHJhbnNwb3J0Ijogew0KICAgICAgICAiZWFybHlfZGF0YV9oZWFkZXJfbmFtZSI6ICJTZWMtV2ViU29ja2V0LVByb3RvY29sIiwNCiAgICAgICAgImhlYWRlcnMiOiB7DQogICAgICAgICAgIkhvc3QiOiAiI2hvc3QjIg0KICAgICAgICB9LA0KICAgICAgICAicGF0aCI6ICIvIiwNCiAgICAgICAgInR5cGUiOiAid3MiDQogICAgICB9LA0KICAgICAgInR5cGUiOiAidHJvamFuIg0KICAgIH0NCiAgXQ0KfQ").replace(a,e=>"#onTls#"===e?!n:r[e]);return`\n####################################################################################################################\n${m("djJyYXk")}\n--------------------------------------------------------------------------------------------------------------------\n${i}\n--------------------------------------------------------------------------------------------------------------------\n####################################################################################################################\n${m("c2luZy1ib3g")}\n--------------------------------------------------------------------------------------------------------------------\n${c}\n--------------------------------------------------------------------------------------------------------------------\n####################################################################################################################\n${m("Y2xhc2gubWV0YSAodHJvamFuK3dzK3Rscyk")}\n--------------------------------------------------------------------------------------------------------------------\n${s}\n--------------------------------------------------------------------------------------------------------------------\n####################################################################################################################\n\t`}var R=[80,8080,8880,2052,2082,2086,2095],j=[443,2053,2083,2087,2096,8443];function W(e){return e[Math.floor(Math.random()*e.length)]}function Y(e,t,n,r){let a=[],i=!!t.endsWith(m("d29ya2Vycy5kZXY"));for(let o of e){if(!o)continue;let e=W(R),s=W(j),c=[0,...j].includes(Number(r))&&i||[0,...R].includes(Number(r))&&!i?i?e:s:r,l={"#password#":n,"#address#":o,"#port#":c,"#host#":t,"#remarks#":`cfwks-${o}:${c}`},I=new RegExp(Object.keys(l).concat("#onTls#").join("|"),"g"),u=m("dHJvamFuOi8vI3Bhc3N3b3JkI0AjYWRkcmVzcyM6I3BvcnQjP3NlY3VyaXR5PSNvblRscyMmdHlwZT13cyZob3N0PSNob3N0IyZwYXRoPSUyRiMjcmVtYXJrcyM").replace(I,e=>"#onTls#"===e?i?"none":m("dGxzJnNuaT0jaG9zdCMmZnA9Y2hyb21lJmFsbG93SW5zZWN1cmU9MQ").replace("#host#",t):l[e]);a.includes(u)||a.push(u)}return P(a.join("\n"))}function F(e,t,n,r){let a=[],i=[],o=!!t.includes(m("d29ya2Vycy5kZXY"));for(let s of e){if(!s)continue;let e=W(R),c=W(j),l=[0,...j].includes(Number(r))&&o||[0,...R].includes(Number(r))&&!o?o?e:c:r,I=`cfwks-${s}:${l}`,u={"#password#":n,"#server#":s,"#port#":l,"#hostName#":t,"#remarks#":I},g=new RegExp(Object.keys(u).join("|"),"g"),d=m("ICAtIHsidHlwZSI6InRyb2phbiIsIm5hbWUiOiIjcmVtYXJrcyMiLCJzZXJ2ZXIiOiIjc2VydmVyIyIsInBvcnQiOiNwb3J0IywicGFzc3dvcmQiOiIjcGFzc3dvcmQjIiwibmV0d29yayI6IndzIiwidWRwIjpmYWxzZSwic25pIjoiI2hvc3ROYW1lIyIsImNsaWVudC1maW5nZXJwcmludCI6ImNocm9tZSIsInNraXAtY2VydC12ZXJpZnkiOnRydWUsIndzLW9wdHMiOnsicGF0aCI6Ii8iLCJoZWFkZXJzIjp7Ikhvc3QiOiIjaG9zdE5hbWUjIn19fQ").replace(g,e=>u[e]);i.includes(I)||(a.push(d),i.push(I))}return[i,a]}function X(e,t,n,r){let a=[],i=[],o=!!t.includes(m("d29ya2Vycy5kZXY"));for(let s of e){if(!s)continue;let e=W(R),c=W(j),l=[0,...j].includes(Number(r))&&o||[0,...R].includes(Number(r))&&!o?o?e:c:r,I=`cfwks-${s}:${l}`,u={"#password#":n,"#server#":s,"#port#":l,"#hostName#":t,"#tagname#":I,"#onTls#":!o},g=new RegExp(Object.keys(u).join("|"),"g"),d=m("ICAgIHsNCiAgICAgICJuZXR3b3JrIjogInRjcCIsDQogICAgICAicGFzc3dvcmQiOiAiI3Bhc3N3b3JkIyIsDQogICAgICAic2VydmVyIjogIiNzZXJ2ZXIjIiwNCiAgICAgICJzZXJ2ZXJfcG9ydCI6ICNwb3J0IywNCiAgICAgICJ0YWciOiAiI3RhZ25hbWUjIiwNCiAgICAgICJ0bHMiOiB7DQogICAgICAgICJlbmFibGVkIjogI29uVGxzIywNCiAgICAgICAgImluc2VjdXJlIjogdHJ1ZSwNCiAgICAgICAgInNlcnZlcl9uYW1lIjogIiNob3N0TmFtZSMiLA0KICAgICAgICAidXRscyI6IHsNCiAgICAgICAgICAiZW5hYmxlZCI6IHRydWUsDQogICAgICAgICAgImZpbmdlcnByaW50IjogImNocm9tZSINCiAgICAgICAgfQ0KICAgICAgfSwNCiAgICAgICJ0cmFuc3BvcnQiOiB7DQogICAgICAgICJlYXJseV9kYXRhX2hlYWRlcl9uYW1lIjogIlNlYy1XZWJTb2NrZXQtUHJvdG9jb2wiLA0KICAgICAgICAiaGVhZGVycyI6IHsNCiAgICAgICAgICAiSG9zdCI6ICIjaG9zdE5hbWUjIg0KICAgICAgICB9LA0KICAgICAgICAicGF0aCI6ICIvIiwNCiAgICAgICAgInR5cGUiOiAid3MiDQogICAgICB9LA0KICAgICAgInR5cGUiOiAidHJvamFuIg0KICAgIH0").replace(g,e=>u[e]);i.includes(I)||(a.push(d),i.push(I))}return[i,a]}var re="",D=`${["2001","67c","2960","6464"].join(":")}::`,U="a1234567",z=O(U),K={hostname:null,port:null},$=["https://www.bilibili.com","https://www.nicovideo.jp","https://tv.naver.com","https://www.hotstar.com","https://www.netflix.com","https://www.dailymotion.com","https://www.youtube.com","https://www.hulu.com","https://fmovies.llc","https://hdtodayz.to","https://radar.cloudflare.com"],ne={github:{GITHUB_TOKEN:"",GITHUB_OWNER:"",GITHUB_REPO:"",GITHUB_BRANCH:"main",GITHUB_FILE_PATH:"README.md"},password:{CONFIG_PASSWORD:"",SUB_PASSWORD:""},urls:{DATA_SOURCE_URL:"https://raw.githubusercontent.com/juerson/cftrojan-tunnel/refs/heads/master/domain.txt",CLASH_TEMPLATE_URL:"https://raw.githubusercontent.com/juerson/cftrojan-tunnel/refs/heads/master/clashTemplate.yaml"}},Q={v2ray:{upperLimit:2e3,default:300},singbox:{upperLimit:100,default:30},clash:{upperLimit:100,default:30},"":{upperLimit:500,default:300}},Re={async fetch(e,t,n){try{D=t.NAT64_IPV6PREFIX||D;let n=t.LANDING_ADDRESS||re,r=t.PASS_CODE||U;r!==U&&(z=O(r));let a=new URL(e.url),i=a.pathname,o=e.headers.get("Upgrade");if(o&&"websocket"===o){i.includes("/pyip=")&&(n=i.split("/pyip=")[1]);let t=L(n);return K={hostname:t?.hostname,port:t?.port},await ie(e)}{let e={env:oe(t,ne),query:se(a,Q)};return await ae(i,e,r,Q)}}catch(e){return new Response(e.toString())}}};function oe(e,t,n=["CONFIG_PASSWORD","SUB_PASSWORD"]){let r={};for(let[a,i]of Object.entries(t)){r[a]={};for(let[t,o]of Object.entries(i)){let i=e[t]??o;n.includes(t)&&(i=encodeURIComponent(String(i))),r[a][t]=i}}return r}function se(e,t,n=["pwdPassword"]){let r=e.searchParams,a=r.get("target")||"",i=t[a]?.default??t[""]?.default,o={target:a,hostName:r.get("host")||e.hostname,pwdPassword:r.get("pwd")||"",defaultPort:parseInt(r.get("port")||"0",10),maxNode:parseInt(r.get("max")||i.toString(),10),page:parseInt(r.get("page")||"1",10)};for(let e of n)e in o&&(o[e]=encodeURIComponent(o[e]));return o}async function ae(e,t,n,r){let{target:a,hostName:i,pwdPassword:o,defaultPort:s,maxNode:c,page:l}=t.query,{CONFIG_PASSWORD:I,SUB_PASSWORD:u}=t.env.password,{DATA_SOURCE_URL:g,CLASH_TEMPLATE_URL:d}=t.env.urls,C=t.env.github;switch(e){case"/":let e=$[Math.floor(Math.random()*$.length)];return new Response(null,{status:301,headers:{Location:e}});case"/config":let t="404 Not Found",A=404;return o==I&&(t=B(n,i),A=200),new Response(t,{status:A,headers:{"Content-Type":"text/plain;charset=utf-8"}});case"/sub":if(o==u){let e="";if(function(e){return Object.values(e).every(e=>""!==e)}(C))try{let t=await V(C?.GITHUB_TOKEN,C?.GITHUB_OWNER,C?.GITHUB_REPO,C?.GITHUB_FILE_PATH,C?.GITHUB_BRANCH);e=(new TextDecoder).decode(t.body)}catch{}if(e.trim()||(e=await J(g)),!e.trim())return new Response("Null Data",{status:200,headers:{"Content-Type":"text/plain;charset=utf-8"}});let t=G(e.trim().split(/\r\n|\n|\r/).map(e=>e.trim()).filter(e=>e.length>0),c,l,r[a]?.upperLimit??r[""]?.upperLimit,r[a]?.default??r[""]?.default);if(t?.hasError)return new Response((t.message,{status:200,headers:{"Content-Type":"text/plain; charset=utf-8"}}));let o="Unknown Error";if(a===m("djJyYXk"))o=Y(t?.chunkedIPs,i,n,s);else if(a===m("Y2xhc2g")){if(i.endsWith(m("d29ya2Vycy5kZXY")))return o=m("6K2m5ZGK77ya5L2/55So5Z+f5ZCNI2hvc3ROYW1lI+eUn+aIkOeahGNsYXNo6K6i6ZiF5peg5rOV5L2/55So77yB57uI5q2i5pON5L2c44CC").replace("#hostName#",i),new Response(o,{status:200,headers:{"Content-Type":"text/plain; charset=utf-8"}});let[e,r]=F(t?.chunkedIPs,i,n,s),a=await J(d);e.length>0&&r.length>0&&(o=function(e,t){return e.replace(/(\s*[-*]\s*)\$\{(\w+)\}/g,(e,n,r)=>"\n"+t[r])}(a,{proxies:r.join("\n"),proxy_name:e.map(e=>`      - ${e}`).join("\n")}))}else if(a===m("c2luZ2JveA")){let[e,r]=X(t?.chunkedIPs,i,n,s);o=m("ew0KICAib3V0Ym91bmRzIjogWw0KI291dGJkcyMNCiAgXQ0KfQ").replace("#outbds#",r.join(",\n"))}return new Response(o,{status:200,headers:{"Content-Type":"text/plain; charset=utf-8"}})}default:return new Response("404 Not Found!",{status:404,headers:{"Content-Type":"text/plain; charset=utf-8"}})}}async function ie(e){let t=new WebSocketPair,[n,r]=Object.values(t);r.accept();let a="",i="",o=(e,t)=>{},s=e.headers.get("sec-websocket-protocol")||"",c=ue(r,s,o),l={value:null,writer:null};return c.pipeTo(new WritableStream({async write(e,t){if(l.writer)return void await l.writer.write(e);if(l.value)return l.writer=l.value.writable.getWriter(),void await l.writer.write(e);let n=await ce(e,z);n&&!n.hasError&&(a=n?.addressRemote,i=`${n?.portRemote}--${Math.random()} tcp`,le(l,a,n?.portRemote,n?.rawClientData,r,o))},close(){},abort(e){JSON.stringify(e)}})).catch(e=>{}),new Response(null,{status:101,webSocket:n})}async function ce(e,t){if(e.byteLength<56)return{hasError:!0,message:"invalid data"};if(13!==new Uint8Array(e.slice(56,57))[0]||10!==new Uint8Array(e.slice(57,58))[0])return{hasError:!0,message:"invalid header format (missing CR LF)"};if((new TextDecoder).decode(e.slice(0,56))!==t)return{hasError:!0,message:"invalid password"};let n=e.slice(58);if(n.byteLength<6)return{hasError:!0,message:"invalid SOCKS5 request data"};let r=new DataView(n);if(1!==r.getUint8(0))return{hasError:!0,message:"unsupported command, only TCP (CONNECT) is allowed"};let a=r.getUint8(1),i=0,o=2,s="";switch(a){case 1:i=4,s=new Uint8Array(n.slice(o,o+i)).join(".");break;case 3:i=new Uint8Array(n.slice(o,o+1))[0],o+=1,s=(new TextDecoder).decode(n.slice(o,o+i));break;case 4:i=16;let e=new DataView(n.slice(o,o+i)),t=[];for(let n=0;n<8;n++)t.push(e.getUint16(2*n).toString(16));s=t.join(":");break;default:return{hasError:!0,message:`invalid addressType is ${a}`}}if(!s)return{hasError:!0,message:`address is empty, addressType is ${a}`};let c=o+i,l=n.slice(c,c+2);return{hasError:!1,addressRemote:s,portRemote:new DataView(l).getUint16(0),rawClientData:n.slice(c+4)}}async function le(e,t,n,r,a,i){async function o(t,n){let a=te({hostname:t,port:n});e.value=a,i(`connected to ${t}:${n}`);let o=a.writable.getWriter();return await o.write(r),o.releaseLock(),a}_(await o(t,n),a,async function(){let{address:e,port:r}=await de(t,n),s=await o(e,r);s.closed.catch(e=>{}).finally(()=>H(ws)),_(s,a,null,i)},i)}async function de(e,t,n=K){return n?.hostname?{address:n.hostname,port:n.port||t}:{address:await Ie(e)||e,port:t}}async function Ie(e,t=D){if("string"!=typeof e||!e.trim())return"";try{let n=await fetch(`https://1.1.1.1/dns-query?name=${e}&type=A`,{headers:{Accept:"application/dns-json"}});if(!n.ok)return"";let r=(await n.json()).Answer?.find(e=>1===e.type)?.data;if(!r)return"";let a=r.split(".");if(4!==a.length)return"";let i=a.map(e=>{let t=Number(e);return!Number.isInteger(t)||t<0||t>255?null:t.toString(16).padStart(2,"0")});return i.includes(null)?"":`[${t}${i[0]}${i[1]}:${i[2]}${i[3]}]`}catch{return""}}function ue(e,t,n){let r=!1;return new ReadableStream({start(a){e.addEventListener("message",e=>{r||a.enqueue(e.data)}),e.addEventListener("close",()=>{r||a.close(),H(e)}),e.addEventListener("error",e=>{n("WebSocket error"),a.error(e)});let{earlyData:i,error:o}=ge(t);o?a.error(o):i&&a.enqueue(i)},cancel(t){r||(r=!0,n(`ReadableStream canceled: ${t}`),H(e))}})}async function _(e,t,n,r){let a=!1;await e.readable.pipeTo(new WritableStream({start(){},async write(e,n){a=!0,t.readyState!==WebSocket.OPEN&&n.error("webSocket connection is not open"),t.send(e)},close(){r(`remoteSocket.readable is closed, hasIncomingData: ${a}`)},abort(e){}})).catch(e=>{H(t)}),!1===a&&n&&(r("retry"),n())}function ge(e){if(!e)return{earlyData:null,error:null};try{let t=e.replace(/-/g,"+").replace(/_/g,"/"),n=atob(t),r=n.length,a=new Uint8Array(r);for(let e=0;e<r;e++)a[e]=n.charCodeAt(e);return{earlyData:a.buffer,error:null}}catch(e){return{earlyData:null,error:e}}}function H(e,t=1e3,n="Normal Closure"){try{(e.readyState===WebSocket.OPEN||e.readyState===WebSocket.CONNECTING)&&e.close(t,n)}catch{}}export{Re as default};